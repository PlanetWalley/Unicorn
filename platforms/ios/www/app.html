<html>
    <head>
        <meta charset="utf-8">
        <meta content="telephone=no" name="format-detection">
        <meta content="no" name="msapplication-tap-highlight">
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
        <meta content=
        "user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi"
        name="viewport">
        <!-- <link href="css/index.css" rel="stylesheet" type="text/css"> -->
        <link href=
        "http://code.jquery.com/mobile/1.4.4/jquery.mobile-1.4.4.min.css" rel=
        "stylesheet">
        <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
        <script src=
        "http://code.jquery.com/mobile/1.4.4/jquery.mobile-1.4.4.min.js"></script>
        <script src="https://code.jquery.com/ui/1.11.1/jquery-ui.js"></script>
        
        
        <script src="cordova.js" type="text/javascript"></script> 
        <script src="js/index.js" type="text/javascript"></script> 
        
        <title>Unicorn Project</title>
    </head>
    
    <body>
        Welcome here;
        <p id="user_id"> Hello There</p>
        <p id="longitude">Longitude</p>
        <p id="latitude">Latitude</p>
        <p id="count">0</p>
        
        <input data-clear-btn="true" id="status" name="status" type=
            "text">
        <button id="change_status_btn">Change Status</button>
    </body>
    <script>
        document.addEventListener("deviceready", onDeviceReady, false);
        function onDeviceReady(){
            $(document).ready(function(){
                var count = 0;
                var postit_id = null;
                var data_fetched = true;
                
                document.addEventListener("pause", function(){ // Enter Background mode, 进入后台模式
                    console.log("Device Paused");
                    setInterval(function(){
                        // count += 10;
                    }, 1000);
                }, false);
                
                document.addEventListener("resume", function(){
                    console.log("Device Resumed");
                }, false);

                console.log("App is ready");
                $("#user_id").html(window.localStorage["user_id"]);
                $("#status").val( window.localStorage["status"]);
                var showPosition = function(position){
                    $("#longitude").html("longitude2: " + position.coords.longitude);
                    $("#latitude").html("latitude2: " + position.coords.latitude);
                    $("#count").html(count);
                    console.log("count" + count);
                    navigator.geolocation.clearWatch(postit_id);
                    if(data_fetched){
                        data_fetched = false;
                        $.ajax({
                                url: "http://planetwalley.com/postit_test/upload_user_data.php",
                                async: false,
                                type: "POST",
                                // 下面是发送的信息
                                data:{longitude: position.coords.longitude,
                                      latitude: position.coords.latitude, 
                                      user_id: window.localStorage["user_id"]}
                            }).done(function(data){
                                if(data === "Success"){
                                }
                                else{
                                    console.log("user failed to upload location");
                                }
                                data_fetched = true;
                                
                            }).fail(function(data){
                                console.log("Failed");
                                data_fetched = true;
                            })                          
                        
                    }
                    else{ // data not fetched, so we are fetching data now
                        return;
                    }
                    count++;
                    //setTimeout(function(){
                    //    getLocation()
                    //}, 10000); // get location after 10 s
                }
                var geolocationError = function(error){
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            alert("User denied the request for Geolocation.");
                            break;
                        case error.POSITION_UNAVAILABLE:
                            alert("Location information is unavailable.");
                            break;
                        case error.TIMEOUT:
                            alert("The request to get user location timed out.");
                            break;
                        case error.UNKNOWN_ERROR:
                            alert("An unknown error occurred.");
                            break;
                    }
                }

                var getLocation = function(){
                    if (navigator.geolocation) {
                        postit_id = navigator.geolocation.watchPosition(showPosition,      
                                                                        geolocationError, 
                                                            {
                                                               enableHighAccuracy: true,
                                                               maximumAge: 0, //这两个iOS下不管用
                                                               timeout: 10000
                                                            });
                    } else {
                         alert("Geolocation is not supported.");
                    }            
                }
                getLocation();
                setInterval(function(){
                        if(data_fetched){
                            getLocation();
                        }
                        else{
                            // do nothing
                        }
                    }, 10000); // update every 10 seconds
                
            })             
        }                 
    </script>
    <script src="js/change_status.js"></script>
</html>